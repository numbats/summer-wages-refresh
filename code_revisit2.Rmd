---
title: "code_revisit_2"
author: "Dewi Lestari Amaliah"
date: "21/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(readr)
library(tidyr)
library(tidyverse)
library(brolgar)
library(patchwork)
library(naniar)
```

```{r}

# load the downloaded data 
new_data_qnames <- read_rds(here::here("data-raw/wages-high-school-demo/data-frames/wages-high-school-demo-new_data_qnames.rds"))
categories_qnames <- read_rds(here::here("data-raw/wages-high-school-demo/data-frames/wages-high-school-demo-categories_qnames.rds"))

```


## get hours of work

```{r}

year_A <- c(1979:1987, 1993)
get_hour <- function(year){
  if(year %in% year_A){
   new_data_qnames %>%
    select(CASEID_1979,
            starts_with("QES-52A") &
              ends_with(as.character(year))) %>%
    pivot_longer(!CASEID_1979,
                 names_to = "job",
                 values_to = "hours_work") %>%
    separate("job", c("job", "year"), sep = -4) %>%
    mutate(job = paste0("job_", substr(job, 9, 10))) %>%
    rename(id = CASEID_1979)}
  else{
    new_data_qnames %>%
    select(CASEID_1979,
            starts_with("QES-52D") &
              ends_with(as.character(year))) %>%
    pivot_longer(!CASEID_1979,
                 names_to = "job",
                 values_to = "hours_work") %>%
    separate("job", c("job", "year"), sep = -4) %>%
    mutate(job = paste0("job_", substr(job, 9, 10))) %>%
    rename(id = CASEID_1979)
  }
 }
```

```{r}


hours <- list()

for(ayear in c(1979:1994, 1996, 1998, 2000, 2002, 2004, 2006, 2008, 2010, 
               2012, 2014, 2016)) {
   hours[[ayear]] <- get_hour(ayear)
}

hours_all <- bind_rows(!!!hours)

```


## get rates

```{r}
get_rate <- function(year) {
  new_data_qnames %>%
     select(CASEID_1979,
            starts_with("HRP") &
              ends_with(as.character(year))) %>%
    pivot_longer(!CASEID_1979, names_to = "job", values_to = "rate_per_hour") %>%
    separate("job", c("job", "year"), sep = -4) %>%
    mutate(job = paste0("job_0", substr(job, 4, 4))) %>%
    rename(id = CASEID_1979)
}
```

```{r}
rates <- list()

for(ayear in c(1979:1994, 1996, 1998, 2000, 2002, 2004, 2006, 2008, 2010, 
               2012, 2014, 2016)) {
   rates[[ayear]] <- get_rate(ayear)
}

rates_all <- bind_rows(!!!rates)
```

## join hours and rates

```{r}

hours_wages <- left_join(rates_all, 
                         hours_all, 
                         by = c("id", "year", "job"))
```

## filter how many observations that having rates but "NA" in hours worked

```{r}
na_hours <- hours_wages %>%
  filter(!is.na(rate_per_hour) & is.na(hours_work))

percentage_na_hours <- nrow(na_hours)/ nrow(hours_wages) * 100
percentage_na_hours
```

There are `r round(percentage_na_hours, 2)` percent of data that missing in hours worked, but not missing in wages.

## filter how many observations that "having"NA" in rates, but present in hours worked

```{r}
na_rates <- hours_wages %>%
  filter(is.na(rate_per_hour) & !is.na(hours_work))

percentage_na_rates <- nrow(na_rates)/ nrow(hours_wages) * 100
percentage_na_rates

```


# calculate the wages (weighted mean approach)


## SCENARIO 1 
- For the obs with more than one jobs, and one of the job has na in hours_work, we can not calculate the weighted average.
- For the obs with only one job and the hours_work is na, we only will use the rates directly.
- Calculate the weighted hours normally

```{r}

# calculate number of jobs that a person has in one year
no_job <- hours_wages %>%
  filter(!is.na(rate_per_hour)) %>%
  group_by(id, year) %>%
  summarise(no_jobs = n_distinct(rate_per_hour))

# filter the observations with available rate per hour
eligible_wages <- hours_wages %>%
  filter(!is.na(rate_per_hour)) %>%
  left_join(no_job, by = c("id", "year"))
```


```{r}
wages_weighted_sc1 <- 
  eligible_wages %>%
  group_by(id, year) %>%
  mutate(wages = ifelse(no_jobs == 1, rate_per_hour/100,
                        weighted.mean(rate_per_hour, hours_work, na.rm = TRUE)/100))

visdat::vis_dat(wages_weighted_sc1, warn_large_data = FALSE)

```

Note: We lose the information in many observations with half complete of hours_work. Example:
observation 506.

```{r}
wages_weighted_sc1 %>% filter(id == 506)
```
```{r}
wages_tidy_sc1 <- wages_weighted_sc1 %>%
  filter(!is.na(wages)) %>%
  group_by(id, year) %>%
  summarise(wages = mean(wages),
            total_hours = sum(hours_work),
            number_of_jobs = mean(no_jobs)) %>%
  mutate(year = as.numeric(year)) %>%
  ungroup() %>%
  mutate(wages = ifelse(wages > 30,
                        NA, wages))
```

```{r}
wages_sc1 <- as_tsibble(x = wages_tidy_sc1,
                    key = id,
                    index = year,
                    regular = FALSE)

sc1_plot <- ggplot(wages_sc1) +
  geom_line(aes(x = year,
                y = wages, 
                group = id), 
            alpha = 0.1) +
  ggtitle("Scenario 1")

sc1_plot

```

```{r}
set.seed(2020)
ggplot(wages_sc1) +
  geom_line(aes(x = year,
                y = wages,
                group = id)) +
  facet_sample()
  
```
```{r features}
wages_feature_sc1 <- wages_sc1 %>%
  features(wages, 
           feat_three_num
           )
```

```{r p1}
p1 <- ggplot(wages_feature_sc1) +
  geom_density(aes(x = min), fill = "magenta", alpha = 0.5)
```


```{r p2}

wages_feature_long_sc1 <- wages_feature_sc1 %>%
  pivot_longer(c(min, med, max), names_to = "feature", values_to = "value")
  
p2 <- ggplot(wages_feature_long_sc1) +
  geom_density(aes(x = value, colour = feature, fill = feature), alpha = 0.3) +
  theme(legend.position = "None")
```


```{r p3}
p3 <- ggplot(transform(wages_feature_long_sc1,
                 feature = factor(feature, level = 
                                 c("min",
                                   "med", 
                                   "max")))) +
  geom_line(aes(x = feature,
                y = value, 
                group = id), alpha = 0.5)
```

```{r feature-charts}

sc1 <- p1+p2+p3
sc1


```


## SCENARIO 2

So, let us try scenario 2, by exclude the observation with more than one job with NA in hours_work.

```{r}
wages_weighted_sc2 <- eligible_wages %>%
  filter(no_jobs == 1 |
           (no_jobs > 1 & !is.na(hours_work))) %>%
  group_by(id, year) %>%
  mutate(wages = ifelse(no_jobs == 1, rate_per_hour/100,
                        weighted.mean(rate_per_hour, hours_work, na.rm = TRUE)/100))

visdat::vis_dat(wages_weighted_sc2, warn_large_data = FALSE)
  
```
```{r}

wages_weighted_sc2 %>% filter(id == 506)
```


```{r}
wages_tidy_sc2 <- wages_weighted_sc2 %>%
  group_by(id, year) %>%
  summarise(wages = mean(wages),
            total_hours = sum(hours_work),
            number_of_jobs = mean(no_jobs)) %>%
  mutate(year = as.numeric(year)) %>%
  ungroup() %>%
  mutate(wages = ifelse(wages > 30,
                        NA, wages))
```

```{r}
wages_sc2 <- as_tsibble(x = wages_tidy_sc2,
                    key = id,
                    index = year,
                    regular = FALSE)
```

```{r}
sc2_plot <- ggplot(wages_sc2) +
  geom_line(aes(x = year,
                y = wages,
                group = id), 
            alpha = 0.1) +
  ggtitle("Scenario 2")
```

```{r}
set.seed(2021)
ggplot(wages_sc2, aes(x = year,
                y = wages,
                group = id)) +
  geom_line() +
  facet_sample()
```

```{r features}
wages_feature_sc2<- wages_sc2 %>%
  features(wages, 
           feat_three_num
           )
```

```{r p1}
p4 <- ggplot(wages_feature_sc2) +
  geom_density(aes(x = min), fill = "magenta", alpha = 0.5)
```


```{r p2}

wages_feature_long_sc2 <- wages_feature_sc2 %>%
  pivot_longer(c(min, med, max), names_to = "feature", values_to = "value")
  
p5 <- ggplot(wages_feature_long_sc2) +
  geom_density(aes(x = value, colour = feature, fill = feature), alpha = 0.3) +
  theme(legend.position = "None")
```


```{r p3}
p6 <- ggplot(transform(wages_feature_long_sc2,
                 feature = factor(feature, level = 
                                 c("min",
                                   "med", 
                                   "max")))) +
  geom_line(aes(x = feature,
                y = value, 
                group = id), alpha = 0.5)
```

```{r feature-charts}

sc2 <- p4+p5+p6
sc2

```

## SCENARIO 3 (modified SC1) 

In this scenario, we treated the observation with the wages higher than $100 as NA

```{r}
wages_tidy_sc3 <- wages_weighted_sc1 %>%
  filter(!is.na(wages)) %>%
  group_by(id, year) %>%
  summarise(wages = mean(wages)) %>%
  mutate(year = as.numeric(year)) %>%
  ungroup() %>%
  mutate(wages = ifelse(wages > 100,
                        NA, wages))
```

```{r}
wages_sc3 <- as_tsibble(x = wages_tidy_sc3,
                    key = id,
                    index = year,
                    regular = FALSE)
```

```{r}
ggplot(wages_sc3) +
  geom_line(aes(x = year,
                y = wages,
                group = id), 
            alpha = 0.1)
```

```{r}
set.seed(2021)
ggplot(wages_sc3, aes(x = year,
                y = wages,
                group = id)) +
  geom_line() +
  facet_sample()
```


## SCENARIO 4 (modified SC2)

```{r}
wages_tidy_sc4 <- wages_weighted_sc2 %>%
  group_by(id, year) %>%
  summarise(wages = mean(wages)) %>%
  mutate(year = as.numeric(year)) %>%
  ungroup() %>%
  mutate(wages = ifelse(wages > 100,
                        NA, wages))
```


```{r}
wages_sc4 <- as_tsibble(x = wages_tidy_sc4,
                    key = id,
                    index = year,
                    regular = FALSE)
```

```{r}
ggplot(wages_sc4) +
  geom_line(aes(x = year,
                y = wages,
                group = id), 
            alpha = 0.1)
```

```{r}
set.seed(2021)
ggplot(wages_sc4, aes(x = year,
                y = wages,
                group = id)) +
  geom_line() +
  facet_sample()
```

## SUMMARY

### The original tidy wages

```{r}
ori <- read_csv("data-raw/wages-high-school-demo/data-frames/tidy_employment.csv") %>%
  mutate(mean_hourly_wage = ifelse( mean_hourly_wage > 30,
                        NA, mean_hourly_wage))
```


```{r}
fig_all_transp <- ggplot(ori) +
  geom_line(aes(x = year,
                y = mean_hourly_wage,
                group = CASEID_1979),
            alpha = 0.1) +
  ggtitle("Original data")
```

```{r wages_tsibble}
wages_ori <- as_tsibble(x = ori,
                    key = CASEID_1979,
                    index = year,
                    regular = FALSE)
```

```{r}
wages_obs <- wages_ori %>%
  features(mean_hourly_wage, n_obs) %>%
  arrange(n_obs)
```


### sc1 + sc2 + original tidy employment data 


```{r}
sc1_plot + sc2_plot + fig_all_transp
```

Number of observations

```{r}
nrow(wages_ori) #regular mean
nrow(wages_sc1) #weighted mean omit id with NA in the working hours
nrow(wages_sc2) #weighted mean omit obs with NA in the working hours
```

Number of ids

```{r}
nrow(wages_obs)
nrow(wages_feature_sc1)
nrow(wages_feature_sc2)
```

